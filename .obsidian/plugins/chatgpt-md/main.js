/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var pe=Object.defineProperty;var Ye=Object.getOwnPropertyDescriptor;var je=Object.getOwnPropertyNames;var ze=Object.prototype.hasOwnProperty;var Je=(c,e)=>{for(var t in e)pe(c,t,{get:e[t],enumerable:!0})},Xe=(c,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of je(e))!ze.call(c,i)&&i!==t&&pe(c,i,{get:()=>e[i],enumerable:!(r=Ye(e,i))||r.enumerable});return c};var Ze=c=>Xe(pe({},"__esModule",{value:!0}),c);var et={};Je(et,{default:()=>le});module.exports=Ze(et);var qe=require("obsidian");var me=require("obsidian");var K=require("obsidian"),Y=class extends K.Modal{constructor(e,t,r){super(e),this.folderName=t,this.folderPath=r,this.result=!1,this.modalPromise=new Promise(i=>{this.resolveModalPromise=i})}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:`[ChatGPT MD] No ${this.folderName} folder found.`}),e.createEl("p",{text:`If you choose "Yes, Create", the plugin will automatically create a folder at: ${this.folderPath}. You can change this path in the plugin settings.`}),new K.Setting(e).addButton(t=>t.setButtonText("Yes, Create Folder").setTooltip("Create folder").setCta().onClick(()=>{this.result=!0,this.resolveModalPromise(this.result),this.close()})),new K.Setting(e).addButton(t=>t.setButtonText("No, I'll create it myself").setTooltip("Cancel").setCta().onClick(()=>{this.result=!1,this.resolveModalPromise(this.result),this.close()}))}waitForModalValue(){return this.modalPromise}onClose(){let{contentEl:e}=this;e.empty()}};var Se=async(c,e,t)=>{let r=new Y(c,e,t);r.open();let i=await r.waitForModalValue();return i?(console.log("[ChatGPT MD] Creating folder"),await c.vault.createFolder(t)):console.log("[ChatGPT MD] Not creating folder"),i};var $=class{constructor(e){this.app=e}async writeInferredTitle(e,t){var s,a;let r=e.file;if(!r)throw new Error("No file is currently open");let i=this.sanitizeFileName(t),o=(a=(s=r.parent)==null?void 0:s.path)!=null?a:"/",n=`${o}/${i}.md`;for(let l=1;await this.app.vault.adapter.exists(n);l++)n=`${o}/${i} (${l}).md`;try{await this.app.fileManager.renameFile(r,n)}catch(l){throw new me.Notice("[ChatGPT MD] Error writing inferred title to editor"),console.log("[ChatGPT MD] Error writing inferred title to editor",l),l}}sanitizeFileName(e){return e.replace(/[\\/:*?"<>|]/g,"-")}async ensureFolderExists(e,t){return!await this.app.vault.adapter.exists(e)&&!await Se(this.app,t,e)?(new me.Notice(`[ChatGPT MD] No ${t} found. One must be created to use the plugin. Set one in settings and make sure it exists.`),!1):!0}async createNewFile(e,t){return this.app.vault.create(e,t)}async readFile(e){return this.app.vault.read(e)}async getLinkedNoteContent(e){try{let t=this.app.metadataCache.getFirstLinkpathDest(e,"");return t?await this.app.vault.read(t):null}catch(t){return console.error(`Error reading linked note: ${e}`,t),null}}formatDate(e,t){return e.toISOString().replace(/[-:]/g,"").replace(/\..+/,"")}};var h="ollama",u="openai",m="openrouter",ve={[u]:"/v1/chat/completions",[m]:"/api/v1/chat/completions",[h]:"/api/chat"},Ae="add-comment-block",Ee="add-hr",Ce="call-chatgpt-api",Re="stop-streaming",_e="move-to-chat",Te="infer-title",we="choose-chat-template",ye="clear-chat",Me=`I am sorry. There was an authorization issue with the external API (Status 401).
Please check your API key in the settings`,Pe=`I am sorry. There was an issue reaching the network.
Please check your network connection.`,Ie="I am sorry, your request looks wrong. Please check your URL or model name in the settings or frontmatter.",j="I am sorry, I could not answer your request because of an error, here is what went wrong:",ge="chatFolder",Oe="chatTemplateFolder",g=`

`,M=/---[\s\S]*?---/g,Ne=/\[\[([^\][]+)\]\]/g,Fe=/\[([^\]]+)\]\(([^()]+)\)/g,xe=`=begin-chatgpt-md-comment${g}`,De="=end-chatgpt-md-comment",Le=3,de=6,be="English",$e=4,z="YYYYMMDDhhmmss",Ge="Failed to fetch",he="__chatgpt_plugin",G=`<hr class="${he}">`,y="role::",P="assistant";var E="user",J=`---
system_commands: ['I am a helpful assistant.']
frequency_penalty: 0
max_tokens: 300
model: gpt-4o-mini
n: 1
presence_penalty: 0
stop: null
stream: true
temperature: 1
---`;var ke=c=>{let t=(c.match(/```/g)||[]).length%2!==0;return t&&console.log("[ChatGPT MD] Unclosed code block detected"),t};var Qe=c=>{let e=c.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&").replace("YYYY","\\d{4}").replace("MM","\\d{2}").replace("DD","\\d{2}").replace("hh","\\d{2}").replace("mm","\\d{2}").replace("ss","\\d{2}");return new RegExp(`^${e}$`)},Ue=(c="",e)=>(c==null?void 0:c.length)==e.length&&Qe(e).test(c),I=c=>c===0?"":c>de?"#".repeat(de)+" ":"#".repeat(c)+" ",W=(c,e,t)=>`${g}${G}${g}${c}${y}${e}${t?`<span style="font-size: small;"> (${t})</span>`:""}${g}`,X=c=>{let t=c.replace(/^---\n/,"").replace(/\n---$/,"").split(`
`),r={},i=null,o=[];for(let n=0;n<t.length;n++){let s=t[n].trim();if(!s)continue;if(i!==null)if(s.startsWith("-")){let d=s.substring(1).trim();(d.startsWith("'")&&d.endsWith("'")||d.startsWith('"')&&d.endsWith('"'))&&(d=d.substring(1,d.length-1)),o.push(d);continue}else r[i]=o,i=null,o=[];let a=s.indexOf(":");if(a===-1)continue;let l=s.substring(0,a).trim(),p=s.substring(a+1).trim();if(p===""&&n+1<t.length&&t[n+1].trim().startsWith("-")){i=l,o=[];continue}p.startsWith("[")&&p.endsWith("]")?r[l]=p.slice(1,-1).split(",").map(d=>{let f=d.trim();return f.startsWith("'")&&f.endsWith("'")||f.startsWith('"')&&f.endsWith('"')?f.slice(1,-1):f}):p==="true"?r[l]=!0:p==="false"?r[l]=!1:p==="null"?r[l]=null:isNaN(Number(p))?r[l]=p:r[l]=Number(p)}return i!==null&&(r[i]=o),r};var k=class{addHorizontalRule(e,t,r){let i=`${g}<hr class="${he}">${g}${I(r)}${y}${t}${g}`,o=e.getCursor();e.replaceRange(i,o),e.setCursor(o.line+i.split(`
`).length-1,0)}appendMessage(e,t,r){let i=I(r),o=W(i,P),n=W(i,E);e.replaceRange(`${o}${t}${n}`,e.getCursor())}clearChat(e){let r=e.getValue().match(M);if(r!=null&&r.length){let[i]=r;e.setValue(i),e.setCursor({line:e.lastLine()+1,ch:0})}else e.setValue("")}moveCursorToEnd(e){try{let r={line:e.lastLine()+1,ch:0};e.setCursor(r)}catch(t){throw new Error("Error moving cursor to end of file"+t)}}addCommentBlock(e,t,r){let i=e.getCursor(),o=`${t}${g}${r}`;e.replaceRange(o,i),e.setCursor({line:i.line+1,ch:i.ch})}};var U=class{constructor(e,t){this.fileService=e;this.notificationService=t}findLinksInMessage(e){let t=[{regex:Ne,fullMatchIndex:0,titleIndex:1},{regex:Fe,fullMatchIndex:0,titleIndex:2}],r=[],i=new Set;for(let{regex:o,fullMatchIndex:n,titleIndex:s}of t)for(let a of e.matchAll(o)){let l=a[n],p=a[s];p&&!i.has(p)&&!p.startsWith("http://")&&!p.startsWith("https://")&&(r.push({link:l,title:p}),i.add(p))}return r}splitMessages(e){return e?e.split(G):[]}removeYAMLFrontMatter(e){return e&&e.replace(M,"").trim()}removeCommentsFromMessages(e){try{let t=/=begin-chatgpt-md-comment[\s\S]*?=end-chatgpt-md-comment/g;return e.replace(t,"")}catch(t){return this.notificationService.showError("Error removing comments from messages: "+t),e}}extractRoleAndMessage(e){try{if(!e.includes(y))return{role:E,content:e};let[t,...r]=e.split(y)[1].split(`
`);return{role:this.cleanupRole(t),content:r.join(`
`).trim()}}catch(t){return this.notificationService.showError("Failed to extract role and message: "+t),{role:E,content:e}}}cleanupRole(e){let t=e.trim().toLowerCase(),i=[E,P].find(o=>t.includes(o));return i||(this.notificationService.showWarning(`Unknown role: "${e}", defaulting to user`),E)}cleanMessagesFromNote(e){return this.splitMessages(this.removeYAMLFrontMatter(e.getValue())).map(r=>this.removeCommentsFromMessages(r))}async getMessagesFromEditor(e,t){let r=this.cleanMessagesFromNote(e);r=await Promise.all(r.map(async o=>{let n=this.findLinksInMessage(o);for(let s of n)try{let a=await this.fileService.getLinkedNoteContent(s.title);if(a){let l=new RegExp(`${g}${G}${g}#+ ${y}(?:${E}|${P}).*$`,"gm");a=a==null?void 0:a.replace(l,"").replace(M,""),o=o.replace(new RegExp(this.escapeRegExp(s.link),"g"),`${g}${s.title}${g}${a}${g}`)}else console.warn(`Error fetching linked note content for: ${s.link}`)}catch(a){console.error(a)}return o}));let i=r.map(o=>this.extractRoleAndMessage(o));return{messages:r,messagesWithRole:i}}addSystemCommandsToMessages(e,t){return!t||t.length===0?e:[...t.map(i=>({role:"system",content:i})),...e]}getHeaderRole(e,t,r){return`${g}${G}${g}${e}${y}${t}${r?`<span style="font-size: small;"> (${r})</span>`:""}${g}`}unfinishedCodeBlock(e){let t=e.match(/```/g);return t!==null&&t.length%2!==0}formatMessage(e,t,r){let i=I(t);return`${this.getHeaderRole(i,e.role,r)}${e.content}`}appendMessage(e,t,r){let i=I(r),o=this.getHeaderRole(i,P),n=this.getHeaderRole(i,E);e.replaceRange(`${o}${t}${n}`,e.getCursor())}processResponse(e,t,r){t.mode==="streaming"?t.wasAborted||this.processStreamingResponse(e,r):this.processStandardResponse(e,t,r)}processStreamingResponse(e,t){let r=I(t.headingLevel),i=this.getHeaderRole(r,E);e.replaceRange(i,e.getCursor());let o=e.getCursor(),n={line:o.line,ch:o.ch+i.length};e.setCursor(n)}processStandardResponse(e,t,r){let i=typeof t=="object"&&t.fullString||t,o=typeof t=="object"?t.model:void 0,n=this.unfinishedCodeBlock(i)?i+"\n```":i,s=I(r.headingLevel),a=this.getHeaderRole(s,P,o),l=this.getHeaderRole(s,E);e.replaceRange(`${a}${n}${l}`,e.getCursor())}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var N=require("obsidian");var x=require("obsidian"),Z=class extends x.SuggestModal{constructor(e,t,r){super(e),this.settings=t,this.titleDate=r}getFilesInChatFolder(){let e=this.app.vault.getAbstractFileByPath(this.settings.chatTemplateFolder);if(e!=null)return e.children;throw new x.Notice(`Error getting folder: ${this.settings.chatTemplateFolder}`),new Error(`Error getting folder: ${this.settings.chatTemplateFolder}`)}getSuggestions(e){let t=this.getFilesInChatFolder();return e==""?t.map(r=>({title:r.basename,file:r})).sort((r,i)=>r.title.localeCompare(i.title)):t.filter(r=>r.basename.toLowerCase().includes(e.toLowerCase())).map(r=>({title:r.basename,file:r})).sort((r,i)=>r.title.localeCompare(i.title))}renderSuggestion(e,t){t.createEl("div",{text:e.title})}async onChooseSuggestion(e,t){new x.Notice(`Selected ${e.title}`);let r=await this.app.vault.read(e.file),i=r;!/^---\n[\s\S]*?\n---/.test(r)&&this.settings.defaultChatFrontmatter&&(i=this.settings.defaultChatFrontmatter+`

`+r);let n=`${this.titleDate} ${e.title}`,s=(0,x.normalizePath)(`${this.settings.chatFolder}/${n}.md`),a=1;for(;await this.app.vault.adapter.exists(s);)s=(0,x.normalizePath)(`${this.settings.chatFolder}/${n} (${a}).md`),a++;try{let l=await this.app.vault.create(s,i);await this.app.workspace.openLinkText(l.basename,"",!0)}catch(l){console.error(l)}}};var H=class{constructor(e,t,r){this.app=e;this.fileService=t;this.editorContentService=r}async createNewChatFromTemplate(e,t){try{if(!e.chatFolder||e.chatFolder.trim()===""){new N.Notice("[ChatGPT MD] No chat folder value found. Please set one in settings.");return}if(!e.chatTemplateFolder||e.chatTemplateFolder.trim()===""){new N.Notice("[ChatGPT MD] No chat template folder value found. Please set one in settings.");return}if(!await this.fileService.ensureFolderExists(e.chatFolder,ge)||!await this.fileService.ensureFolderExists(e.chatTemplateFolder,Oe))return;new Z(this.app,e,t).open()}catch(r){console.error("[ChatGPT MD] Error in Create new chat from template",r),new N.Notice("[ChatGPT MD] Error in Create new chat from template, check console")}}async createNewChatWithHighlightedText(e,t){try{let r=e.getSelection();if(!t.chatFolder||t.chatFolder.trim()===""){new N.Notice("[ChatGPT MD] No chat folder value found. Please set one in settings.");return}if(!await this.fileService.ensureFolderExists(t.chatFolder,ge))return;let o=`${this.fileService.formatDate(new Date,t.dateFormat)}.md`,n=`${t.chatFolder}/${o}`,s="";t.defaultChatFrontmatter&&(s=t.defaultChatFrontmatter+`

`),r&&(s+=r);let a=await this.fileService.createNewFile(n,s);await this.app.workspace.openLinkText(a.basename,"",!0,{state:{mode:"source"}});let l=this.app.workspace.getActiveViewOfType(N.MarkdownView);if(!l){new N.Notice("No active markdown editor found.");return}l.editor.focus(),this.editorContentService.moveCursorToEnd(l.editor)}catch(r){console.error("[ChatGPT MD] Error in Create new chat with highlighted text",r),new N.Notice("[ChatGPT MD] Error in Create new chat with highlighted text, check console")}}};var ue=require("obsidian");var He=require("obsidian"),C=class{showNotification(e,t=5e3){new He.Notice(e,t)}formatChatMessage(e,t=!1){return t?`I am sorry. ${e}`:e}showSuccess(e){this.showNotification(`\u2705 ${e}`,3e3)}showWarning(e){this.showNotification(`\u26A0\uFE0F ${e}`,5e3)}showError(e){this.showNotification(`\u274C ${e}`,7e3)}};var v=class{constructor(e){this.notificationService=e||new C}isValidApiKey(e){return!!e&&e.trim()!==""}getApiKey(e,t){switch(t){case u:return e.apiKey;case m:return e.openrouterApiKey;case h:return"";default:return""}}validateApiKey(e,t){if(t!==h&&!this.isValidApiKey(e)){let r=`${t} API key is missing or invalid. Please add your ${t} API key in the settings.`;throw this.notificationService.showError(r),new Error(r)}}createAuthHeaders(e,t){let r={"Content-Type":"application/json"};switch(t){case u:r.Authorization=`Bearer ${e}`;break;case m:r.Authorization=`Bearer ${e}`,r["HTTP-Referer"]="https://github.com/bramses/chatgpt-md",r["X-Title"]="Obsidian ChatGPT MD Plugin";break;case h:break}return r}};var w=class{constructor(e){this.collectedCitations=new Set;this.notificationService=e||new C}insertAssistantHeader(e,t,r){let i=W(t,P,r),o={line:e.getCursor().line,ch:e.getCursor().ch};e.replaceRange(i,o);let n={line:o.line,ch:o.ch+i.length};return e.setCursor(n),{initialCursor:o,newCursor:n}}parseNonStreamingResponse(e,t){var r,i,o;switch(t){case u:return e.choices[0].message.content;case m:return e.choices[0].message.content;case h:return e.message&&e.message.content?e.message.content:e.response?e.response:JSON.stringify(e);default:return console.warn(`Unknown service type: ${t}`),((o=(i=(r=e==null?void 0:e.choices)==null?void 0:r[0])==null?void 0:i.message)==null?void 0:o.content)||(e==null?void 0:e.response)||JSON.stringify(e)}}processStreamLine(e,t,r,i,o,n){switch(o){case u:case m:return this.processOpenAIFormat(e,t,r,i,n);case h:return this.processOllamaFormat(e,t,r,i,n);default:return console.warn(`Unknown service type for streaming: ${o}`),t}}processOpenAIFormat(e,t,r,i,o){if(e.trim()==="")return t;try{let n=JSON.parse(e.replace("data: ",""));if(n.citations&&n.citations.length>0){console.log("Found citations in chunk:",n.citations);for(let s of n.citations)this.collectedCitations.add(s),console.log("Added citation to set:",s);console.log("Current citations set size:",this.collectedCitations.size)}if(n.choices&&n.choices[0]){let{delta:s}=n.choices[0];if(s&&s.content){if(o)r.replaceSelection(s.content);else{let a=r.getCursor();r.replaceRange(s.content,a),r.setCursor({line:a.line,ch:a.ch+s.content.length})}return t+s.content}}return t}catch(n){return t}}processOllamaFormat(e,t,r,i,o){if(e.trim()==="")return t;try{let n=JSON.parse(e);if(n.message&&n.message.content){let s=n.message.content;if(o)r.replaceSelection(s);else{let a=r.getCursor();r.replaceRange(s,a),r.setCursor({line:a.line,ch:a.ch+s.length})}return t+s}if(n.response){if(o)r.replaceSelection(n.response);else{let s=r.getCursor();r.replaceRange(n.response,s),r.setCursor({line:s.line,ch:s.ch+n.response.length})}return t+n.response}return t}catch(n){return t}}async processStreamResponse(e,t,r,i,o,n){let s=e.body.getReader(),a=new TextDecoder,l=!1,p="",d=!1;try{for(;!l;){let{value:f,done:F}=await s.read();if(l=F,l)break;let q=a.decode(f).split(`
`);for(let b of q)b.startsWith("data: [DONE]")||(b.startsWith("data:")?p=this.processStreamLine(b,p,r,i.newCursor,t,o):b.trim()!==""&&(p=this.processStreamLine(b,p,r,i.newCursor,t,o)))}}catch(f){console.error("Error processing stream:",f)}if(n&&n.wasAborted())return d=!0,n.resetAbortedFlag(),o||r.replaceRange("",i.initialCursor,r.getCursor()),{text:"",wasAborted:d};if(ke(p)){let f=r.getCursor();r.replaceRange("\n```",f),p+="\n```"}if(this.collectedCitations.size>0){console.log("Completed streaming response, appending citations"),console.log("Citations to append:",Array.from(this.collectedCitations));let F=`

**Sources:**
`+Array.from(this.collectedCitations).map((q,b)=>`${b+1}. [${q}](${q})`).join(`
`),L=r.getCursor();r.replaceRange(F,L),r.setCursor({line:L.line,ch:L.ch+F.length}),p+=F,this.collectedCitations.clear(),console.log("Citations set cleared after appending to response")}if(!o){let f=r.getCursor();r.replaceRange("",f,{line:1/0,ch:1/0})}return{text:p,wasAborted:d}}};var R=class{constructor(e){this.notificationService=e}handleApiError(e,t,r={showNotification:!0,logToConsole:!0,returnForChat:!1}){var d,f,F,L;let i=`[ChatGPT MD] ${t}`,o="unknown_error",n="",s="",a=((d=r.context)==null?void 0:d.model)||"",l=((f=r.context)==null?void 0:f.url)||"",p=this.formatContextInfo(a,l);if(e instanceof Object?e.name==="AbortError"?(o="stream_aborted",n=`${i}: Stream aborted`,s="Stream aborted"):e.message===Ge?(o="network_error",n=`${i}: Network connection error`,s=Pe):e.status===401||((F=e.error)==null?void 0:F.status)===401?(o="authentication_error",n=`${i}: Authentication failed (401)`,s=Me):e.status===404||((L=e.error)==null?void 0:L.status)===404?(o="not_found_error",n=`${i}: Resource not found (404)${p?` - ${p}`:""}`,s=`${Ie}${p?`${g}${p}`:""}`):e.error?(o="api_error",n=`${i}: ${e.error.message}${p?` - ${p}`:""}`,s=`${j}${g}${e.error.message}${p?`${g}${p}`:""}`):(n=`${i}: ${JSON.stringify(e)}${p?` - ${p}`:""}`,s=`${j}${g}${JSON.stringify(e)}${p?`${g}${p}`:""}`):(n=`${i}: ${e}${p?` - ${p}`:""}`,s=`${j}${g}${e}${p?`${g}${p}`:""}`),r.logToConsole&&console.error(n,e,r.context),r.showNotification&&this.notificationService.showNotification(n,5e3),r.returnForChat)return`I am sorry, I could not answer your request because of an error, here is what went wrong-

${e instanceof Object&&e.error?e.error.message:(e==null?void 0:e.message)||e||"undefined"}

Model- ${a}, URL- ${l}`;throw new Error(n)}formatContextInfo(e,t){let r=[];return e&&r.push(`Model: ${e}`),t&&r.push(`URL: ${t}`),r.length>0?r.join(", "):""}handleUrlError(e,t,r){let i=`[ChatGPT MD] Error calling specified URL: ${e}`;return this.notificationService.showNotification(i),console.error(i,{url:e,defaultUrl:t,serviceName:r}),`I am sorry, I could not answer your request because of an error, here is what went wrong-

Error connecting to the custom URL.

Model- ${r===h?"llama2":"unknown"}, URL- ${e}`}handleModelError(e,t){let r=`[ChatGPT MD] Error calling model: ${e}`;return this.notificationService.showNotification(r),console.error(r,{model:e,serviceName:t}),`I am sorry, there was an error with the model: ${e}. Please check your settings or try a different model.`}handleValidationError(e,t){let r=`[ChatGPT MD] Validation Error: ${e}`;throw this.notificationService.showNotification(r),console.error(r,t),new Error(r)}};var _=class{constructor(e,t,r,i){this.abortController=null;this.wasStreamingAborted=!1;this.notificationService=t||new C,this.errorService=e||new R(this.notificationService),this.apiAuthService=r||new v,this.apiResponseParser=i||new w}async makeStreamingRequest(e,t,r,i){try{console.log(`[ChatGPT MD] Making streaming request to ${i}`,t),this.abortController=new AbortController;let o=await fetch(e,{method:"POST",headers:r,body:JSON.stringify(t),signal:this.abortController.signal});if(!o.ok)throw await this.handleHttpError(o,i,t,e);if(!o.body)throw new Error("The response body was empty");return o}catch(o){return this.handleRequestError(o,i,t,e)}}async makeNonStreamingRequest(e,t,r,i){try{console.log(`[ChatGPT MD] Making non-streaming request to ${i}`,t);let n=(await(0,ue.requestUrl)({url:e,method:"POST",headers:r,contentType:"application/json",body:JSON.stringify(t),throw:!1})).json;return n!=null&&n.error?this.errorService.handleApiError({error:n.error},i,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:e}}):this.apiResponseParser.parseNonStreamingResponse(n,i)}catch(o){return this.errorService.handleApiError(o,i,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:e}})}}async makeGetRequest(e,t,r){try{console.log(`[ChatGPT MD] Making GET request to ${r}`);let i=await(0,ue.requestUrl)({url:e,method:"GET",headers:t,throw:!1});if(i.status!==200)throw new Error(`Failed to fetch data from ${e}: ${i.status}`);return i.json}catch(i){throw console.error(`Error making GET request to ${r}:`,i),i}}async handleHttpError(e,t,r,i){let o;try{o=await e.json()}catch(s){o={status:e.status,statusText:e.statusText}}let n=this.errorService.handleApiError(o,t,{returnForChat:!1,showNotification:!0,context:{model:r.model,url:i,status:e.status}});return new Error(n)}handleRequestError(e,t,r,i){return this.errorService.handleApiError(e,t,{returnForChat:!1,showNotification:!0,context:{model:r.model,url:i}})}stopStreaming(){this.abortController&&(this.wasStreamingAborted=!0,this.abortController.abort(),this.abortController=null)}wasAborted(){return this.wasStreamingAborted}resetAbortedFlag(){this.wasStreamingAborted=!1}};var D=class{constructor(e,t){this.inferTitleFromMessages=async(e,t,r)=>{try{if(t.length<2)return this.notificationService.showWarning("Not enough messages to infer title. Minimum 2 messages."),"";let i=`Infer title from the summary of the content of these messages. The title **cannot** contain any of the following characters: colon (:), back slash (\\), forward slash (/), asterisk (*), question mark (?), double quote ("), less than (<), greater than (>), or pipe (|) as these are invalid in file names. Just return the title. Write the title in ${r.inferTitleLanguage}. 
Messages:${g}${JSON.stringify(t)}`,o=this.getDefaultConfig(),n={...o,...r};n.model||(console.log("[ChatGPT MD] Model not set for title inference, using default model"),n.model=o.model),n.url||(console.log("[ChatGPT MD] URL not set for title inference, using default URL"),n.url=o.url),console.log("[ChatGPT MD] Inferring title with model:",n.model);try{return await this.callNonStreamingAPI(e,[{role:E,content:i}],n)}catch(s){return console.error("[ChatGPT MD] Error calling API for title inference:",s),""}}catch(i){return console.error("[ChatGPT MD] Error inferring title:",i),this.showNoTitleInferredNotification(),""}};this.notificationService=t!=null?t:new C,this.errorService=e!=null?e:new R(this.notificationService),this.apiService=new _(this.errorService,this.notificationService),this.apiAuthService=new v(this.notificationService),this.apiResponseParser=new w(this.notificationService)}async callAIAPI(e,t={},r,i,o,n,s,a){let l={...this.getDefaultConfig(),...t};return a&&(l.url=i),t.stream&&o?this.callStreamingAPI(s,e,l,o,r,n):this.callNonStreamingAPI(s,e,l)}async inferTitle(e,t,r,i){try{if(!e.file)throw new Error("No active file found");let o=this.getApiKeyFromSettings(t),n=await this.inferTitleFromMessages(o,r,t),s="";return typeof n=="string"?s=n:n&&typeof n=="object"&&(s=n.fullString||""),s&&s.trim().length>0?(await i.writeInferredTitle(e,s.trim()),s.trim()):(this.showNoTitleInferredNotification(),"")}catch(o){return console.error("[ChatGPT MD] Error in inferTitle:",o),this.showNoTitleInferredNotification(),""}}showNoTitleInferredNotification(){var e;(e=this.notificationService)==null||e.showWarning("Could not infer title. The file name was not changed.")}stopStreaming(){var e;(e=this.apiService)==null||e.stopStreaming()}processStreamingResult(e){return e.wasAborted&&e.text===""?{fullString:"",mode:"streaming",wasAborted:!0}:{fullString:e.text,mode:"streaming",wasAborted:e.wasAborted}}getApiEndpoint(e){return`${e.url}${ve[this.serviceType]}`}prepareApiCall(e,t,r){this.apiAuthService.validateApiKey(e,this.serviceType);let i=this.createPayload(r,t),o=this.apiAuthService.createAuthHeaders(e,this.serviceType);return{payload:i,headers:o}}handleApiCallError(e,t,r=!1){if(console.error(`[ChatGPT MD] ${this.serviceType} API error:`,e),!!r)throw e;return this.errorService.handleApiError(e,this.serviceType,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:t.url}})}},Ve=(c,e)=>{if(e!=null&&e.includes(m))return m;if(e!=null&&e.includes("local"))return h;let t="openrouter",r=["localhost","127.0.0.1"];return c!=null&&c.includes(t)?m:r.some(i=>c==null?void 0:c.includes(i))?h:u};var S={aiService:u,frequency_penalty:0,max_tokens:300,model:"gpt-4",n:1,presence_penalty:0,stop:null,stream:!0,system_commands:null,tags:[],temperature:1,title:"Untitled",top_p:1,url:"https://api.openai.com"},Ke=async(c,e)=>{try{let t=new v;if(!t.isValidApiKey(e))return console.error("OpenAI API key is missing. Please add your OpenAI API key in the settings."),[];let r=new _,i=t.createAuthHeaders(e,u);return(await r.makeGetRequest(`${c}/v1/models`,i,u)).data.filter(n=>n.id.includes("gpt")).sort((n,s)=>n.id<s.id?1:n.id>s.id?-1:0).map(n=>n.id)}catch(t){return console.error("Error fetching models:",t),[]}},Q=class extends D{constructor(t,r,i,o,n){super(t,r);this.serviceType=u;this.errorService=t||new R(this.notificationService),this.apiService=i||new _(this.errorService,this.notificationService),this.apiAuthService=o||new v(this.notificationService),this.apiResponseParser=n||new w(this.notificationService)}getDefaultConfig(){return S}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,u)}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,o=r;if(t.system_commands&&t.system_commands.length>0){let n=t.system_commands.map(s=>({role:"developer",content:s}));o=[...n,...r],console.log(`[ChatGPT MD] Added ${n.length} developer commands to messages`)}return{model:i,messages:o,max_completion_tokens:t.max_tokens,temperature:t.temperature,top_p:t.top_p,presence_penalty:t.presence_penalty,frequency_penalty:t.frequency_penalty,stream:t.stream,stop:t.stop,n:t.n}}handleAPIError(t,r,i){let o={model:r.model,url:r.url,defaultUrl:S.url,aiService:u};return t instanceof Object&&r.url!==S.url?this.errorService.handleUrlError(r.url,S.url,u):this.errorService.handleApiError(t,u,{context:o,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,o,n,s){try{let{payload:a,headers:l}=this.prepareApiCall(t,r,i),p=this.apiResponseParser.insertAssistantHeader(o,n,a.model),d=await this.apiService.makeStreamingRequest(this.getApiEndpoint(i),a,l,this.serviceType),f=await this.apiResponseParser.processStreamResponse(d,this.serviceType,o,p,s,this.apiService);return this.processStreamingResult(f)}catch(a){return{fullString:`Error: ${a}`,mode:"streaming"}}}async callNonStreamingAPI(t,r,i){var o;try{console.log('[ChatGPT MD] "no stream"',i),i.stream=!1;let{payload:n,headers:s}=this.prepareApiCall(t,r,i);return{fullString:await this.apiService.makeNonStreamingRequest(this.getApiEndpoint(i),n,s,this.serviceType),model:n.model}}catch(n){let s=r.length===1&&((o=r[0].content)==null?void 0:o.toString().includes("Infer title from the summary"));return this.handleApiCallError(n,i,s)}}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var T={aiService:h,model:"llama2",url:"http://localhost:11434",stream:!0,title:"Untitled",system_commands:null},We=async c=>{try{let e=new _,t={"Content-Type":"application/json"};return(await e.makeGetRequest(`${c}/api/tags`,t,h)).models.sort((o,n)=>o.name<n.name?1:o.name>n.name?-1:0).map(o=>`local@${o.name}`)}catch(e){return console.error("Error fetching models:",e),[]}},ee=class extends D{constructor(t,r,i,o,n){super(t,r);this.serviceType=h;this.errorService=t||new R(this.notificationService),this.apiService=i||new _(this.errorService,this.notificationService),this.apiAuthService=o||new v(this.notificationService),this.apiResponseParser=n||new w(this.notificationService)}getDefaultConfig(){return T}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,h)}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,o=r;if(t.system_commands&&t.system_commands.length>0){let n=t.system_commands.map(s=>({role:"system",content:s}));o=[...n,...r],console.log(`[ChatGPT MD] Added ${n.length} system commands to messages`)}return{model:i,messages:o,stream:t.stream}}handleAPIError(t,r,i){let o={model:r.model,url:r.url,defaultUrl:T.url,aiService:h};return t instanceof Object&&r.url!==T.url?this.errorService.handleUrlError(r.url,T.url,h):this.errorService.handleApiError(t,h,{context:o,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,o,n,s){try{let{payload:a,headers:l}=this.prepareApiCall(t,r,i),p=this.apiResponseParser.insertAssistantHeader(o,n,a.model),d=await this.apiService.makeStreamingRequest(this.getApiEndpoint(i),a,l,this.serviceType),f=await this.apiResponseParser.processStreamResponse(d,this.serviceType,o,p,s,this.apiService);return this.processStreamingResult(f)}catch(a){return console.error("[ChatGPT MD] Ollama streaming error:",a),{fullString:`Error: ${a}`,mode:"streaming"}}}async callNonStreamingAPI(t,r,i){var o;try{console.log('[ChatGPT MD] "no stream"',i),i.stream=!1;let{payload:n,headers:s}=this.prepareApiCall(t,r,i);return{fullString:await this.apiService.makeNonStreamingRequest(this.getApiEndpoint(i),n,s,this.serviceType),model:n.model}}catch(n){let s=r.length===1&&((o=r[0].content)==null?void 0:o.toString().includes("Infer title from the summary"));return this.handleApiCallError(n,i,s)}}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var A={aiService:m,frequency_penalty:.5,max_tokens:300,model:"anthropic/claude-3-opus:beta",openrouterApiKey:"",presence_penalty:.5,stop:null,stream:!0,system_commands:null,tags:[],temperature:.3,title:"Untitled",top_p:1,url:"https://openrouter.ai"},Be=async(c,e)=>{try{let t=new v;if(!t.isValidApiKey(e))return console.error("OpenRouter API key is missing. Please add your OpenRouter API key in the settings."),[];let r=new _,i=t.createAuthHeaders(e,m);return(await r.makeGetRequest(`${c}/api/v1/models`,i,m)).data.sort((n,s)=>n.id<s.id?1:n.id>s.id?-1:0).map(n=>`${m}@${n.id}`)}catch(t){return console.error("Error fetching models:",t),[]}},te=class extends D{constructor(t,r,i,o,n){super(t,r);this.serviceType=m;this.errorService=t||new R(this.notificationService),this.apiService=i||new _(this.errorService,this.notificationService),this.apiAuthService=o||new v(this.notificationService),this.apiResponseParser=n||new w(this.notificationService)}getDefaultConfig(){return A}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,m)}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,o=r;if(t.system_commands&&t.system_commands.length>0){let n=t.system_commands.map(s=>({role:"system",content:s}));o=[...n,...r],console.log(`[ChatGPT MD] Added ${n.length} system commands to messages`)}return{model:i,messages:o,max_tokens:t.max_tokens,temperature:t.temperature,top_p:t.top_p,presence_penalty:t.presence_penalty,frequency_penalty:t.frequency_penalty,stream:t.stream,stop:t.stop}}handleAPIError(t,r,i){let o={model:r.model,url:r.url,defaultUrl:A.url,aiService:m};return t instanceof Object&&r.url!==A.url?this.errorService.handleUrlError(r.url,A.url,m):this.errorService.handleApiError(t,m,{context:o,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,o,n,s){try{let{payload:a,headers:l}=this.prepareApiCall(t,r,i),p=this.apiResponseParser.insertAssistantHeader(o,n,a.model),d=await this.apiService.makeStreamingRequest(this.getApiEndpoint(i),a,l,this.serviceType),f=await this.apiResponseParser.processStreamResponse(d,this.serviceType,o,p,s,this.apiService);return this.processStreamingResult(f)}catch(a){return{fullString:`Error: ${a}`,mode:"streaming"}}}async callNonStreamingAPI(t,r,i){var o;try{console.log('[ChatGPT MD] "no stream"',i),i.stream=!1;let{payload:n,headers:s}=this.prepareApiCall(t,r,i);return{fullString:await this.apiService.makeNonStreamingRequest(this.getApiEndpoint(i),n,s,this.serviceType),model:n.model}}catch(n){let s=r.length===1&&((o=r[0].content)==null?void 0:o.toString().includes("Infer title from the summary"));return this.handleApiCallError(n,i,s)}}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var V=class{constructor(e){this.app=e}getFrontmatter(e,t){let i=e.editor.getValue().match(M),o=i?X(i[0]):{},n=t.defaultChatFrontmatter?X(t.defaultChatFrontmatter):{},s={...t,...n,...o},a=s.aiService||Ve(s.url,s.model)||u;return{...{[u]:S,[h]:T,[m]:A}[a]||S,...t,...n,...o,aiService:a}}updateFrontmatterField(e,t,r){let i=e.getValue(),o=i.match(M),n;if(o){let a=o[0].replace(/---/g,""),l=new RegExp(`^${t}:\\s*(.*)$`,"m");l.test(a)?a=a.replace(l,`${t}: ${r}`):a+=`
${t}: ${r}`,n=i.replace(M,`---${a}---`)}else n=`---
${t}: ${r}
---
${i}`;e.setValue(n)}objectToYamlFrontmatter(e){return`---
${Object.entries(e).map(([r,i])=>i==null?`${r}:`:typeof i=="string"?`${r}: "${i}"`:`${r}: ${i}`).join(`
`)}
---

`}generateFrontmatter(e,t={}){if(e.defaultChatFrontmatter){if(Object.keys(t).length>0){let n={...X(e.defaultChatFrontmatter),...t};return this.objectToYamlFrontmatter(n)}return e.defaultChatFrontmatter+`

`}let r=t.aiService||u,i={stream:e.stream,...t};switch(r){case u:i={...i,model:S.model,temperature:S.temperature,top_p:S.top_p,max_tokens:S.max_tokens,presence_penalty:S.presence_penalty,frequency_penalty:S.frequency_penalty};break;case h:i={...i,model:T.model,url:T.url};break;case m:i={...i,model:A.model,temperature:A.temperature,top_p:A.top_p,max_tokens:A.max_tokens,presence_penalty:A.presence_penalty,frequency_penalty:A.frequency_penalty};break}return this.objectToYamlFrontmatter(i)}};var re=class{constructor(e,t,r,i,o,n){this.app=e;this.fileService=t||new $(e),this.editorContentService=r||new k;let s=new C;this.messageService=i||new U(this.fileService,s),this.frontmatterService=n||new V(e),this.templateService=o||new H(e,this.fileService,this.editorContentService)}async writeInferredTitle(e,t){return this.fileService.writeInferredTitle(e,t)}async ensureFolderExists(e,t){return this.fileService.ensureFolderExists(e,t)}getDate(e,t){return this.fileService.formatDate(e,t)}addHorizontalRule(e,t,r){this.editorContentService.addHorizontalRule(e,t,r)}clearChat(e){this.editorContentService.clearChat(e)}moveCursorToEnd(e){this.editorContentService.moveCursorToEnd(e)}async getMessagesFromEditor(e,t){return this.messageService.getMessagesFromEditor(e,t)}async createNewChatFromTemplate(e,t){return this.templateService.createNewChatFromTemplate(e,t)}async createNewChatWithHighlightedText(e,t){return this.templateService.createNewChatWithHighlightedText(e,t)}getFrontmatter(e,t,r){return this.frontmatterService.getFrontmatter(e,t)}processResponse(e,t,r){this.messageService.processResponse(e,t,r)}setModel(e,t){this.frontmatterService.updateFrontmatterField(e,"model",t)}};var fe={apiKey:"",openrouterApiKey:"",openaiUrl:S.url,openrouterUrl:A.url,ollamaUrl:T.url,chatFolder:"ChatGPT_MD/chats",chatTemplateFolder:"ChatGPT_MD/templates",stream:!0,generateAtCursor:!1,autoInferTitle:!1,dateFormat:z,headingLevel:Le,inferTitleLanguage:be,defaultChatFrontmatter:J};var oe=require("obsidian");var ie=class extends oe.PluginSettingTab{constructor(e,t,r){super(e,t),this.settingsProvider=r}display(){let{containerEl:e}=this;e.empty();let t=[{id:"apiKey",name:"OpenAI API Key",description:"API Key for OpenAI",type:"text",placeholder:"your openAI API Key",group:"API Keys"},{id:"openrouterApiKey",name:"OpenRouter.ai API Key",description:"API Key for OpenRouter.ai",type:"text",placeholder:"your openRouter API Key",group:"API Keys"},{id:"openaiUrl",name:"OpenAI API URL",description:`URL for OpenAI API
Default URL: ${S.url}`,type:"text",placeholder:S.url,group:"Service URLs"},{id:"openrouterUrl",name:"OpenRouter.ai API URL",description:`URL for OpenRouter.ai API
Default URL: ${A.url}`,type:"text",placeholder:A.url,group:"Service URLs"},{id:"ollamaUrl",name:"Ollama API URL",description:`URL for Ollama API
Default URL: ${T.url}`,type:"text",placeholder:T.url,group:"Service URLs"},{id:"defaultChatFrontmatter",name:"Default Chat Frontmatter",description:"Default frontmatter for new chat files. You can change/use all of the settings exposed by the OpenAI API here: https://platform.openai.com/docs/api-reference/chat/create",type:"textarea",placeholder:J,group:"Chat Behavior"},{id:"stream",name:"Stream",description:"Stream responses from OpenAI",type:"toggle",group:"Chat Behavior"},{id:"generateAtCursor",name:"Generate at Cursor",description:"Generate text at cursor instead of end of file",type:"toggle",group:"Chat Behavior"},{id:"autoInferTitle",name:"Automatically Infer Title",description:"Automatically infer title after 4 messages have been exchanged",type:"toggle",group:"Chat Behavior"},{id:"chatFolder",name:"Chat Folder",description:"Path to folder for chat files",type:"text",group:"Folders"},{id:"chatTemplateFolder",name:"Chat Template Folder",description:"Path to folder for chat file templates",type:"text",placeholder:"chat-templates",group:"Folders"},{id:"dateFormat",name:"Date Format",description:"Date format for chat files. Valid date blocks are: YYYY, MM, DD, hh, mm, ss",type:"text",placeholder:z,group:"Formatting"},{id:"headingLevel",name:"Heading Level",description:`Heading level for messages (example for heading level 2: '## ${y}${E}'). Valid heading levels are 0, 1, 2, 3, 4, 5, 6`,type:"text",group:"Formatting"},{id:"inferTitleLanguage",name:"Infer title language",description:"Language to use for title inference.",type:"dropdown",options:{English:"English",Japanese:"Japanese",Spanish:"Spanish",French:"French",German:"German",Chinese:"Chinese",Korean:"Korean",Italian:"Italian",Russian:"Russian"},group:"Formatting"}],r={};t.forEach(i=>{r[i.group]||(r[i.group]=[]),r[i.group].push(i)}),Object.entries(r).forEach(([i,o])=>{e.createEl("h3",{text:i}),o.forEach(n=>{this.createSettingElement(e,n)}),e.createEl("hr")})}createSettingElement(e,t){let r=new oe.Setting(e).setName(t.name).setDesc(t.description);t.type==="text"?r.addText(i=>(i.setPlaceholder(t.placeholder||"").setValue(String(this.settingsProvider.settings[t.id])).onChange(async o=>{this.settingsProvider.settings[t.id]=o,await this.settingsProvider.saveSettings()}),i.inputEl.style.width="300px",i)):t.type==="textarea"?r.addTextArea(i=>(i.setPlaceholder(t.placeholder||"").setValue(String(this.settingsProvider.settings[t.id]||t.placeholder)).onChange(async o=>{this.settingsProvider.settings[t.id]=o,await this.settingsProvider.saveSettings()}),i.inputEl.style.width="300px",t.id==="defaultChatFrontmatter"&&(i.inputEl.style.height="260px",i.inputEl.style.minHeight="260px"),i)):t.type==="toggle"?r.addToggle(i=>i.setValue(!!this.settingsProvider.settings[t.id]).onChange(async o=>{this.settingsProvider.settings[t.id]=o,await this.settingsProvider.saveSettings()})):t.type==="dropdown"&&t.options&&r.addDropdown(i=>(i.addOptions(t.options||{}),i.setValue(String(this.settingsProvider.settings[t.id])),i.onChange(async o=>{this.settingsProvider.settings[t.id]=o,await this.settingsProvider.saveSettings()}),i.selectEl.style.width="300px",i))}};var ne=class{constructor(e,t=new C,r=new R(new C)){this.plugin=e;this.notificationService=t;this.errorService=r;this.settings=structuredClone(fe),this.loadSettings().catch(i=>this.notificationService.showError("Failed to load settings"))}getSettings(){return this.settings}async migrateSettings(){let e=[{setting:"ollamaUrl",pattern:/\/api\/$/,replacement:"",description:"Removing trailing /api/ from Ollama URL",introducedIn:"2.1.3"},{setting:"openrouterUrl",pattern:/\/api\/$/,replacement:"",description:"Removing trailing /api/ from OpenRouter URL",introducedIn:"2.1.3"},{setting:"openaiUrl",pattern:/\/$/,replacement:"",description:"Removing trailing slash from OpenAI URL",introducedIn:"2.1.3"}],t=!1;for(let r of e){let i=r.setting,o=this.settings[i];o&&r.pattern.test(o)&&(this.updateSettings({[i]:o.replace(r.pattern,r.replacement)}),console.log(`[ChatGPT MD] Migration (${r.introducedIn}): ${r.description}`),t=!0)}t&&(await this.saveSettings(),console.log("[ChatGPT MD] Migrated settings"))}async loadSettings(){let e=await this.plugin.loadData();return Object.assign(this.settings,fe,e),this.settings}async saveSettings(){await this.plugin.saveData(this.settings)}updateSettings(e){Object.assign(this.settings,e)}async addSettingTab(){await this.loadSettings(),this.plugin.addSettingTab(new ie(this.plugin.app,this.plugin,{settings:this.settings,saveSettings:this.saveSettings.bind(this)}))}};var se=class{constructor(e,t){this.app=e,this.plugin=t,this.initializeServices()}initializeServices(){this.notificationService=new C,this.errorService=new R(this.notificationService),this.apiService=new _(this.errorService,this.notificationService),this.apiAuthService=new v(this.notificationService),this.apiResponseParser=new w(this.notificationService),this.fileService=new $(this.app),this.editorContentService=new k,this.messageService=new U(this.fileService,this.notificationService),this.frontmatterService=new V(this.app),this.templateService=new H(this.app,this.fileService,this.editorContentService),this.editorService=new re(this.app,this.fileService,this.editorContentService,this.messageService,this.templateService,this.frontmatterService),this.settingsService=new ne(this.plugin,this.notificationService,this.errorService)}getAiApiService(e){switch(e){case u:return new Q(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case h:return new ee(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case m:return new te(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);default:throw new Error(`Unknown AI service type: ${e}`)}}getFileService(){return this.fileService}getEditorContentService(){return this.editorContentService}getMessageService(){return this.messageService}getTemplateService(){return this.templateService}getFrontmatterService(){return this.frontmatterService}getEditorService(){return this.editorService}getNotificationService(){return this.notificationService}getErrorService(){return this.errorService}getApiService(){return this.apiService}getApiAuthService(){return this.apiAuthService}getApiResponseParser(){return this.apiResponseParser}getSettingsService(){return this.settingsService}};var O=require("obsidian");var ae=require("obsidian"),B=class extends ae.SuggestModal{constructor(e,t,r,i=[]){super(e),this.modelNames=i,this.editor=t,this.editorService=r,this.modelNames.length>0?this.setPlaceholder("Select Large Language Model"):this.setPlaceholder("Loading available models...")}getSuggestions(e){return this.modelNames.filter(t=>t.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e})}onChooseSuggestion(e,t){this.modelNames.indexOf(e)===-1||this.modelNames.length===0||(new ae.Notice(`Selected model: ${e}`),this.editorService.setModel(this.editor,e))}};var ce=class{constructor(e,t,r){this.aiService=null;this.plugin=e,this.serviceLocator=t,this.settingsService=r,this.statusBarItemEl=e.addStatusBarItem(),this.apiAuthService=new v}registerCommands(){this.registerChatCommand(),this.registerSelectModelCommand(),this.registerAddDividerCommand(),this.registerAddCommentBlockCommand(),this.registerStopStreamingCommand(),this.registerInferTitleCommand(),this.registerMoveToNewChatCommand(),this.registerChooseChatTemplateCommand(),this.registerClearChatCommand()}registerChatCommand(){this.plugin.addCommand({id:Ce,name:"Chat",icon:"message-circle",editorCallback:async(e,t)=>{var n;let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),o=r.getFrontmatter(t,i,this.plugin.app);this.aiService=this.serviceLocator.getAiApiService(o.aiService);try{let{messagesWithRole:s,messages:a}=await r.getMessagesFromEditor(e,i);i.generateAtCursor||r.moveCursorToEnd(e),O.Platform.isMobile?new O.Notice(`[ChatGPT MD] Calling ${o.model}`):this.updateStatusBar(`Calling ${o.model}`);let l=this.apiAuthService.getApiKey(i,o.aiService),p=await this.aiService.callAIAPI(s,o,I(i.headingLevel),this.getAiApiUrls(o)[o.aiService],e,i.generateAtCursor,l,i);if(r.processResponse(e,p,i),i.autoInferTitle&&Ue((n=t==null?void 0:t.file)==null?void 0:n.basename,i.dateFormat)&&s.length>$e){let d={...o,openrouterApiKey:this.apiAuthService.getApiKey(i,m),url:this.getAiApiUrls(o)[o.aiService]};d.model||(console.log("[ChatGPT MD] Model not set for auto title inference, using default model"),o.aiService===u?d.model="gpt-4":o.aiService===h?d.model="llama2":o.aiService===m&&(d.model="anthropic/claude-3-opus:beta")),console.log("[ChatGPT MD] Auto-inferring title with settings:",{aiService:o.aiService,model:d.model}),await this.aiService.inferTitle(t,d,a,r)}}catch(s){O.Platform.isMobile&&new O.Notice(`[ChatGPT MD] Calling ${o.model}. `+s,9e3),console.log(s)}this.updateStatusBar("")}})}registerSelectModelCommand(){this.plugin.addCommand({id:"select-model-command",name:"Select Model",icon:"list",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),o=new B(this.plugin.app,e,r);o.open();let n=r.getFrontmatter(t,i,this.plugin.app);this.aiService=this.serviceLocator.getAiApiService(n.aiService);try{let s=this.apiAuthService.getApiKey(i,u),a=this.apiAuthService.getApiKey(i,m),l=await this.fetchAvailableModels(this.getAiApiUrls(n),s,a);o.close(),new B(this.plugin.app,e,r,l).open()}catch(s){o.close(),new O.Notice("Could not find any models"),console.error(s)}}})}registerAddDividerCommand(){this.plugin.addCommand({id:Ee,name:"Add divider",icon:"minus",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings();r.addHorizontalRule(e,E,i.headingLevel)}})}registerAddCommentBlockCommand(){this.plugin.addCommand({id:Ae,name:"Add comment block",icon:"comment",editorCallback:(e,t)=>{let r=e.getCursor(),i=r.line,o=r.ch,n=`${xe}${g}${De}`;e.replaceRange(n,r);let s={line:i+1,ch:o};e.setCursor(s)}})}registerStopStreamingCommand(){this.plugin.addCommand({id:Re,name:"Stop streaming",icon:"octagon",callback:()=>{this.aiService&&"stopStreaming"in this.aiService?this.aiService.stopStreaming():this.serviceLocator.getNotificationService().showWarning("No active streaming request to stop")}})}registerInferTitleCommand(){this.plugin.addCommand({id:Te,name:"Infer title",icon:"subtitles",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),o=r.getFrontmatter(t,i,this.plugin.app);if(this.aiService=this.serviceLocator.getAiApiService(o.aiService),!o.model){console.log("[ChatGPT MD] Model not set in frontmatter, using default model");return}this.updateStatusBar(`Calling ${o.model}`);let{messages:n}=await r.getMessagesFromEditor(e,i),s={...i,...o,openrouterApiKey:this.apiAuthService.getApiKey(i,m),url:this.getAiApiUrls(o)[o.aiService]};await this.aiService.inferTitle(t,s,n,r),this.updateStatusBar("")}})}registerMoveToNewChatCommand(){this.plugin.addCommand({id:_e,name:"Create new chat with highlighted text",icon:"highlighter",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings();try{await r.createNewChatWithHighlightedText(e,i)}catch(o){console.error("[ChatGPT MD] Error in Create new chat with highlighted text",o),new O.Notice("[ChatGPT MD] Error in Create new chat with highlighted text, check console")}}})}registerChooseChatTemplateCommand(){this.plugin.addCommand({id:we,name:"Create new chat from template",icon:"layout-template",callback:async()=>{let e=this.serviceLocator.getEditorService(),t=this.settingsService.getSettings();if(t.dateFormat){await e.createNewChatFromTemplate(t,e.getDate(new Date,t.dateFormat));return}new O.Notice("date format cannot be empty in your ChatGPT MD settings. You can choose something like YYYYMMDDhhmmss")}})}registerClearChatCommand(){this.plugin.addCommand({id:ye,name:"Clear chat (except frontmatter)",icon:"trash",editorCallback:async(e,t)=>{this.serviceLocator.getEditorService().clearChat(e)}})}getAiApiUrls(e){return{openai:e.openaiUrl||S.url,openrouter:e.openrouterUrl||A.url,ollama:e.ollamaUrl||T.url}}async fetchAvailableModels(e,t,r){try{let i=new v,o=await We(e[h]),n=[];i.isValidApiKey(t)&&(n=await Ke(e[u],t));let s=[];return i.isValidApiKey(r)&&(s=await Be(e[m],r)),[...o,...n,...s]}catch(i){throw new O.Notice("Error fetching models: "+i),console.error("Error fetching models:",i),i}}updateStatusBar(e){this.statusBarItemEl.setText(`[ChatGPT MD] ${e}`)}};var le=class extends qe.Plugin{async onload(){this.serviceLocator=new se(this.app,this);let e=this.serviceLocator.getSettingsService();await e.loadSettings(),await e.migrateSettings(),await e.addSettingTab(),this.commandRegistry=new ce(this,this.serviceLocator,e),this.commandRegistry.registerCommands()}};

/* nosourcemap */